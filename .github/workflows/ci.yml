name: 'CI'

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  test:
    name: 'Test Action'
    runs-on: ubuntu-latest
    
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4
        
      - name: 'Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          
      - name: 'Install dependencies'
        run: yarn install --frozen-lockfile
        
      - name: 'Lint code'
        run: yarn lint
        
      - name: 'Run tests'
        run: yarn test
        
      - name: 'Build action'
        run: yarn build
        
      - name: 'Check for uncommitted changes'
        run: |
          echo "=== Checking for uncommitted changes in dist/ ==="
          git status dist/
          echo "\n=== Git diff output (with ignore-space-at-eol): ==="
          git diff --ignore-space-at-eol dist/
          echo "\n=== Line count of diff: ==="
          git diff --ignore-space-at-eol dist/ | wc -l
          
          DIFF_LINES=$(git diff --ignore-space-at-eol dist/ | wc -l | tr -d ' ')
          echo "Diff lines: '$DIFF_LINES'"
          
          if [ "$DIFF_LINES" -gt "0" ]; then
            echo "\n❌ Detected uncommitted changes after build. See status above."
            echo "This usually means the dist/ directory needs to be rebuilt and committed."
            exit 1
          else
            echo "\n✅ No uncommitted changes detected in dist/ directory."
          fi
